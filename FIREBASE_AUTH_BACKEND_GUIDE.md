# Firebase Authentication - Backend Implementation Guide

## Overview

The frontend is migrating from mock authentication (X-USER-ID header) to Firebase Authentication with Google Sign-In. This document explains what the backend needs to implement.

---

## Authentication Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           AUTHENTICATION FLOW                                 │
└──────────────────────────────────────────────────────────────────────────────┘

1. User clicks "Sign in with Google" on frontend
2. Firebase handles OAuth flow with Google
3. User authenticates with Google
4. Firebase returns a User object with:
   - uid: "abc123xyz..." (unique Firebase identifier)
   - email: "user@gmail.com"
   - displayName: "John Doe"
   - photoURL: "https://..."
5. Frontend gets ID Token via user.getIdToken()
6. Frontend sends API requests with: Authorization: Bearer <id_token>
7. Backend verifies token with Firebase Admin SDK
8. Backend extracts uid and uses it as the user identifier

┌─────────┐      ┌──────────┐      ┌─────────┐      ┌─────────┐
│  User   │ ──▶  │  Google  │ ──▶  │Firebase │ ──▶  │Frontend │
│         │      │  OAuth   │      │  Auth   │      │         │
└─────────┘      └──────────┘      └─────────┘      └────┬────┘
                                                         │
                                                         │ Authorization: Bearer <token>
                                                         ▼
                                                   ┌─────────┐
                                                   │ Backend │
                                                   │   API   │
                                                   └─────────┘
```

---

## What is Firebase UID?

- **Format**: A string like `"Ux7kP9mNqRsT2vWxYz"` (typically 28 characters)
- **Properties**:
  - Globally unique across all Firebase projects
  - Immutable - never changes for a user
  - Generated by Firebase, not controllable
- **Important**: This replaces your current numeric user IDs

### Example Firebase User Object
```json
{
  "uid": "Ux7kP9mNqRsT2vWxYz1234567890",
  "email": "john.doe@gmail.com",
  "displayName": "John Doe",
  "photoURL": "https://lh3.googleusercontent.com/a/..."
}
```

---

## Backend Changes Required

### 1. Install Firebase Admin SDK

```bash
# Node.js
npm install firebase-admin

# Python
pip install firebase-admin

# Java/Kotlin
implementation 'com.google.firebase:firebase-admin:9.x.x'
```

### 2. Initialize Firebase Admin

You need a **Service Account Key** from Firebase Console:
1. Go to Firebase Console → Project Settings → Service Accounts
2. Click "Generate new private key"
3. Save the JSON file securely (NEVER commit to git)

```javascript
// Node.js Example
const admin = require('firebase-admin');
const serviceAccount = require('./path-to-service-account-key.json');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});
```

```python
# Python Example
import firebase_admin
from firebase_admin import credentials, auth

cred = credentials.Certificate('path-to-service-account-key.json')
firebase_admin.initialize_app(cred)
```

### 3. Create Authentication Middleware

Replace your current `X-USER-ID` header logic with token verification:

```javascript
// Node.js/Express Example
const verifyFirebaseToken = async (req, res, next) => {
  const authHeader = req.headers.authorization;
  
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).json({ error: 'No token provided' });
  }
  
  const idToken = authHeader.split('Bearer ')[1];
  
  try {
    // Verify the token with Firebase Admin SDK
    const decodedToken = await admin.auth().verifyIdToken(idToken);
    
    // Attach user info to request
    req.user = {
      uid: decodedToken.uid,           // "Ux7kP9mNqRsT2vWxYz..."
      email: decodedToken.email,       // "user@gmail.com"
      name: decodedToken.name,         // "John Doe"
      picture: decodedToken.picture    // Photo URL
    };
    
    next();
  } catch (error) {
    console.error('Token verification failed:', error);
    return res.status(401).json({ error: 'Invalid token' });
  }
};

// Apply to all protected routes
app.use('/api', verifyFirebaseToken);
```

```python
# Python/FastAPI Example
from firebase_admin import auth
from fastapi import Header, HTTPException

async def verify_firebase_token(authorization: str = Header(...)):
    if not authorization.startswith('Bearer '):
        raise HTTPException(status_code=401, detail='No token provided')
    
    token = authorization.split('Bearer ')[1]
    
    try:
        decoded_token = auth.verify_id_token(token)
        return {
            'uid': decoded_token['uid'],
            'email': decoded_token.get('email'),
            'name': decoded_token.get('name'),
            'picture': decoded_token.get('picture')
        }
    except Exception as e:
        raise HTTPException(status_code=401, detail='Invalid token')
```

### 4. Database Schema Changes

**Option A: Use Firebase UID as Primary Key (Recommended)**

```sql
-- Change user table to use Firebase UID
ALTER TABLE users 
  DROP COLUMN id,
  ADD COLUMN id VARCHAR(128) PRIMARY KEY; -- Firebase UID

-- Update all foreign keys
ALTER TABLE spaces MODIFY creator_id VARCHAR(128);
ALTER TABLE space_members MODIFY user_id VARCHAR(128);
ALTER TABLE commitments MODIFY creator_id VARCHAR(128);
ALTER TABLE approvers MODIFY user_id VARCHAR(128);
ALTER TABLE invites MODIFY user_id VARCHAR(128);
-- etc.
```

**Option B: Create User on First Login (Auto-Registration)**

```javascript
// In your middleware or a separate endpoint
const getOrCreateUser = async (firebaseUser) => {
  let user = await db.users.findOne({ firebase_uid: firebaseUser.uid });
  
  if (!user) {
    // First time login - create user automatically
    user = await db.users.create({
      firebase_uid: firebaseUser.uid,
      email: firebaseUser.email,
      name: firebaseUser.name || firebaseUser.email.split('@')[0],
      avatar_url: firebaseUser.picture,
      created_at: new Date()
    });
  }
  
  return user;
};
```

### 5. Update All Endpoints

Replace `X-USER-ID` header usage with `req.user.uid`:

```javascript
// BEFORE (current implementation)
app.get('/api/users/me', (req, res) => {
  const userId = req.headers['x-user-id']; // ❌ Insecure
  // ...
});

// AFTER (with Firebase Auth)
app.get('/api/users/me', verifyFirebaseToken, (req, res) => {
  const userId = req.user.uid; // ✅ Verified by Firebase
  // ...
});
```

---

## API Contract Changes

### Request Headers

| Before | After |
|--------|-------|
| `X-USER-ID: 1` | `Authorization: Bearer eyJhbGciOiJSUzI1NiIs...` |

### Token Details

- **Format**: JWT (JSON Web Token)
- **Issued by**: Firebase Authentication
- **Expiry**: 1 hour (frontend handles refresh automatically)
- **Contains**: uid, email, name, picture, email_verified, auth_time, etc.

### Decoded Token Example

```json
{
  "iss": "https://securetoken.google.com/your-project-id",
  "aud": "your-project-id",
  "auth_time": 1706918400,
  "user_id": "Ux7kP9mNqRsT2vWxYz1234567890",
  "sub": "Ux7kP9mNqRsT2vWxYz1234567890",
  "iat": 1706918400,
  "exp": 1706922000,
  "email": "john.doe@gmail.com",
  "email_verified": true,
  "name": "John Doe",
  "picture": "https://lh3.googleusercontent.com/a/...",
  "firebase": {
    "identities": {
      "google.com": ["123456789"],
      "email": ["john.doe@gmail.com"]
    },
    "sign_in_provider": "google.com"
  },
  "uid": "Ux7kP9mNqRsT2vWxYz1234567890"
}
```

---

## Error Responses

The middleware should return these errors:

| Status | Condition | Response |
|--------|-----------|----------|
| 401 | No Authorization header | `{ "error": "No token provided" }` |
| 401 | Invalid/malformed token | `{ "error": "Invalid token" }` |
| 401 | Expired token | `{ "error": "Token expired" }` |
| 403 | User lacks permission | `{ "error": "Forbidden" }` |

---

## Migration Checklist

- [ ] Install Firebase Admin SDK
- [ ] Add Firebase service account credentials (securely)
- [ ] Create token verification middleware
- [ ] Update database schema to use Firebase UID (string)
- [ ] Update `/users/me` endpoint
- [ ] Update `/spaces` endpoints
- [ ] Update `/commitments` endpoints  
- [ ] Update `/invites` endpoints
- [ ] Implement auto-registration on first login
- [ ] Remove X-USER-ID header support
- [ ] Test with frontend

---

## Firebase Console Setup

The frontend team will create the Firebase project. You need:

1. **Project ID**: `your-project-id` (will be shared)
2. **Service Account Key**: JSON file for Admin SDK
3. **Authorized Domains**: Add your API domain if using cookies

---

## Security Notes

1. **Never trust the frontend** - Always verify tokens server-side
2. **Don't log tokens** - They contain sensitive information
3. **Secure the service account key** - Use environment variables, never commit
4. **Validate on every request** - Tokens can be revoked

---

## Questions for Frontend Team

1. What is the Firebase Project ID?
2. Will you provide the service account key file?
3. Do you need any additional user fields stored?
4. Should we support multiple sign-in providers later?

---

## Contact

For questions about the authentication flow or token format, contact the frontend team.
